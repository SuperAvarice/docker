version: '3'

services:
    mariadb:
        image: "${MARIADB_IMAGE}"
        restart: "always"
        environment:
            MYSQL_RANDOM_ROOT_PASSWORD: "yes"
            MYSQL_DATABASE: "grafana"
            MYSQL_USER: "grafana"
            MYSQL_PASSWORD: "${GRAFANA_DB_PASS}"
        volumes:
            - ${ROOT_DIR}/mariadb/log:/var/log/mysql
            - ${ROOT_DIR}/mariadb/data:/var/lib/mysql
            - ${ROOT_DIR}/mariadb/server.cnf:/etc/mysql/conf.d/server.cnf
        ulimits:
            nofile:
                soft: 40000
                hard: 80000

    grafana:
        image: "${GRAFANA_IMAGE}"
        restart: "always"
        environment:
            GF_DATABASE_TYPE: "mysql"
            GF_DATABASE_HOST: "mariadb:3306"
            GF_DATABASE_NAME: "grafana"
            GF_DATABASE_USER: "grafana"
            GF_DATABASE_PASSWORD: "${GRAFANA_DB_PASS}"
            GF_ANALYTICS_REPORTING_ENABLED: "false"
            GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
            GF_SECURITY_ADMIN_USER: "${ADMIN_USER}"
            GF_SECURITY_ADMIN_PASSWORD: "${ADMIN_PASSWORD}"
            GF_AUTH_ANONYMOUS_ENABLED: "${ANONYMOUS_ENABLED}"
            GF_AUTH_ANONYMOUS_ORG_ROLE: "Viewer"
            GF_USERS_ALLOW_SIGN_UP: "false"
            GF_SNAPSHOTS_EXTERNAL_ENABLED: "false"
            GF_INSTALL_PLUGINS: grafana-clock-panel,natel-discrete-panel,grafana-piechart-panel
            GF_LOG_MODE: "file"
            GF_LOG_LEVEL: "warn"
            GF_LOG_FILE_LOG_ROTATE: "true"
            GF_LOG_FILE_DAILY_ROTATE: "true"
            GF_LOG_FILE_MAX_DAYS: "10"
            GF_RENDERING_SERVER_URL: "http://renderer:8081/render"
            GF_RENDERING_CALLBACK_URL: "http://grafana:3000/"
            HTTPS_PROXY: "${http_proxy}"
            HTTP_PROXY: "${http_proxy}"
            NO_PROXY: "$(no_proxy},localhost,renderer,grafana,mariadb"
        ports:
            - "3000:3000"
        volumes:
            - ${ROOT_DIR}/grafana/log:/var/log/grafana
            - ${ROOT_DIR}/grafana/data:/var/lib/grafana
            - ${ROOT_DIR}/grafana/provisioning/:/etc/grafana/provisioning/
        depends_on:
            - mariadb
            - renderer

    renderer:
        image: "${RENDERER_IMAGE}"
        restart: "always"

    telegraf:
        image: "${TELEGRAF_IMAGE}"
        restart: "always"
        environment:
            HOST_ETC: "/hostfs/etc"
            HOST_PROC: "/hostfs/proc"
            HOST_SYS: "/hostfs/sys"
            HOST_VAR: "/hostfs/var"
            HOST_RUN: "/hostfs/run"
            HOST_MOUNT_PREFIX: "/hostfs"
        volumes:
            - /:/hostfs:ro
            - ${ROOT_DIR}/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
            - /var/run/docker.sock:/var/run/docker.sock

    prometheus:
        image: "${PROMETHEUS_IMAGE}"
        restart: "always"
        volumes:
            - ${ROOT_DIR}/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
            - ${ROOT_DIR}/prometheus/data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--storage.tsdb.retention.time=200h'
            - '--web.enable-lifecycle'
